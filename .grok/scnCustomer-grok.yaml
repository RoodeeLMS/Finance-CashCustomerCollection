Screens:
  scnCustomer-grok:
    Properties:
      LoadingSpinnerColor: =RGBA(56, 96, 178, 1)
      OnVisible: |-
        =UpdateContext({currentScreen: "Customer Management"});
        UpdateContext({currentMode: "View"});
        Set(_showMenu, false);
        UpdateContext({showConfirmationPopup: false});
        UpdateContext({dataSourceIdentifier: ""});
        UpdateContext({recordToDelete: Blank()});
        UpdateContext({recordPrimaryProperty: ""});
        UpdateContext({grok_selectedCustomer: Blank()});
        Refresh(nc_customers)
    Children:
      - grok_Header:
          Control: GroupContainer@1.3.0
          Variant: AutoLayout
          Properties:
            DropShadow: =DropShadow.Regular
            Fill: =LookUp(Navigation, name = currentScreen, color)
            Height: =55
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutDirection: =LayoutDirection.Horizontal
            PaddingLeft: =15
            RadiusBottomLeft: =8
            RadiusBottomRight: =8
            RadiusTopLeft: =8
            RadiusTopRight: =8
            Width: =Parent.Width - 20
            X: =10
            Y: =10
          Children:
            - grok_MenuIcon:
                Control: Classic/Icon@0.0.7
                Properties:
                  BorderColor: =RGBA(0, 18, 107, 1)
                  Fill: =Color.White
                  Height: =50
                  Icon: =Icon.Hamburger
                  OnSelect: =Set(_showMenu, !_showMenu)
                  PaddingBottom: =10
                  PaddingLeft: =10
                  PaddingRight: =10
                  PaddingTop: =10
                  Width: =50
            - grok_Title:
                Control: Text@0.0.51
                Properties:
                  AlignInContainer: =AlignInContainer.Center
                  Font: =Font.Lato
                  FontColor: =Color.White
                  Height: =50
                  PaddingLeft: =20
                  Size: =25
                  Text: =currentScreen
                  VerticalAlign: =VerticalAlign.Middle
                  Weight: ='TextCanvas.Weight'.Medium
                  Width: =240
      - grok_MainContainer:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            DropShadow: =DropShadow.Regular
            Height: =Parent.Height
            Width: =Parent.Width
          Children:
            - grok_Content:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(255, 255, 255, 1)
                  Height: =Parent.Height - 85
                  RadiusBottomLeft: =10
                  RadiusBottomRight: =10
                  RadiusTopLeft: =10
                  RadiusTopRight: =10
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =75
                Children:
                  - grok_SearchContainer:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        Height: =50
                        LayoutDirection: =LayoutDirection.Horizontal
                        LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                        Padding: =10
                        Width: =Parent.Width
                      Children:
                        - grok_SearchInput:
                            Control: TextInput@0.0.54
                            Properties:
                              Default: =""
                              Mode: ='TextInputCanvas.Mode'.SingleLine
                              Width: =Parent.Width / 3
                              Height: =40
                              OnChange: =Set(grok_searchFilter, Self.Value); Refresh(grok_CustomerGallery)
                        - grok_RegionFilter:
                            Control: ComboBox@0.0.45
                            Properties:
                              Items: =Distinct(nc_customers, nc_region)
                              DefaultSelectedItems: =[]
                              Width: =Parent.Width / 3
                              Height: =40
                              DisplayFields: =["Value"]
                              SearchFields: =["Value"]
                              OnChange: =Refresh(grok_CustomerGallery)
                        - grok_AddBtn:
                            Control: Button@0.0.45
                            Properties:
                              Text: ="New Customer"
                              Width: =100
                              Height: =40
                              OnSelect: =Set(editMode, true); Set(grok_selectedCustomer, Defaults(nc_customers)); NewForm(grok_CustomerForm)
                              Visible: =_isARAdmin
                  - grok_CustomerGallery:
                      Control: Gallery@2.15.0
                      Variant: BrowseLayout_Vertical_TwoTextVariant_ver5.0
                      Properties:
                        Items: =Filter(Sort(nc_customers, nc_customername, Ascending), 
                                       IsBlank(grok_searchFilter) || 
                                       nc_customername Like "*" & grok_searchFilter & "*" || 
                                       nc_customercode Like "*" & grok_searchFilter & "*",
                                       IsBlank(grok_RegionFilter.Selected.Value) || nc_region = grok_RegionFilter.Selected.Value,
                                       nc_isactive = true)
                        Width: =Parent.Width
                        Height: =Parent.Height - 150
                        TemplateSize: =80
                        OnSelect: =Set(grok_selectedCustomer, ThisItem); Set(editMode, false); EditForm(grok_CustomerForm)
                      Children:
                        - grok_CustomerCard:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              Width: =Parent.TemplateWidth
                              Height: =Parent.TemplateHeight
                              LayoutDirection: =LayoutDirection.Horizontal
                              Padding: =10
                              Fill: =If(ThisItem.nc_isactive, Color.White, RGBA(255, 0, 0, 0.1))
                            Children:
                              - grok_CustomerIcon:
                                  Control: Icon@0.0.7
                                  Properties:
                                    Icon: =If(ThisItem.nc_qrcodeavailable, Icon.CheckMark, Icon.Warning)
                                    Fill: =If(ThisItem.nc_qrcodeavailable, Color.Green, Color.Orange)
                                    X: =10
                                    Y: =10
                                    Width: =30
                                    Height: =30
                              - grok_NameLabel:
                                  Control: Label@2.5.1
                                  Properties:
                                    Text: =ThisItem.nc_customername & " (" & ThisItem.nc_customercode & ")"
                                    X: =50
                                    Y: =5
                                    Width: =Parent.Width - 100
                                    Height: =25
                                    Font: =Font.Lato
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    AutoHeight: =true
                              - grok_RegionLabel:
                                  Control: Label@2.5.1
                                  Properties:
                                    Text: =ThisItem.nc_region
                                    X: =50
                                    Y: =30
                                    Width: =Parent.Width - 100
                                    Height: =20
                                    FontColor: =RGBA(100, 100, 100, 1)
                                    AutoHeight: =true
                              - grok_EditButtonWrapper:
                                  Control: Button@0.0.45
                                  Properties:
                                    Height: =30
                                    Width: =30
                                    X: =Parent.TemplateWidth - 40
                                    Y: =Parent.TemplateHeight / 2 - 15
                                    OnSelect: =Set(editMode, true); Set(grok_selectedCustomer, ThisItem); EditForm(grok_CustomerForm)
                                    BorderStyle: =BorderStyle.None
                                    Fill: =Color.Transparent
                                    Visible: =_isARAdmin
                                  Children:
                                    - grok_EditIconInner:
                                        Control: Icon@0.0.7
                                        Properties:
                                          Icon: =Icon.Edit
                                          Fill: =Color.Gray
                                          Width: =Parent.Width
                                          Height: =Parent.Height
                  - grok_CustomerFormSection:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        Width: =Parent.Width
                        Height: =200
                        Y: =grok_CustomerGallery.Y + grok_CustomerGallery.Height + 10
                        Visible: =!IsBlank(grok_selectedCustomer)
                        LayoutDirection: =LayoutDirection.Vertical
                        Padding: =10
                      Children:
                        - grok_CustomerForm:
                            Control: Form@2.0.0
                            Properties:
                              Item: =grok_selectedCustomer
                              DataSource: =nc_customers
                              Width: =Parent.Width
                              Height: =Parent.Height
                              DefaultMode: =FormMode.Edit
                            Children:
                              - grok_CodeField:
                                  Control: CanvasComponent
                                  ComponentName: cmpEditableText
                                  Properties:
                                    TitleText: ="Customer Code"
                                    Value: =grok_selectedCustomer.nc_customercode
                                    EditMode: =editMode && _isARAdmin
                                    MaxLength: =20
                                    Width: =Parent.Width - 20
                                    Height: =60
                                    ErrorFlag: =IsBlank(grok_selectedCustomer.nc_customercode)
                              - grok_NameField:
                                  Control: CanvasComponent
                                  ComponentName: cmpEditableText
                                  Properties:
                                    TitleText: ="Customer Name"
                                    Value: =grok_selectedCustomer.nc_customername
                                    UpdatedValue: =grok_NameField.UpdatedValue
                                    EditMode: =editMode
                                    MaxLength: =255
                                    Width: =Parent.Width - 20
                                    Height: =60
                              - grok_RegionField:
                                  Control: DropDown@0.0.45
                                  Properties:
                                    Items: =["NO", "SO", "NE", "CE"]
                                    DefaultSelectedItems: =[grok_selectedCustomer.nc_region]
                                    Width: =Parent.Width - 20
                                    Height: =50
                                    OnChange: =If(IsBlank(Self.Selected.Value), Notify("Region required", NotificationType.Warning), Blank())
                              - grok_Email1Field:
                                  Control: TextInput@0.0.54
                                  Properties:
                                    Value: =grok_selectedCustomer.nc_customeremail1
                                    Mode: ='TextInputCanvas.Mode'.SingleLine
                                    Width: =Parent.Width - 20
                                    Height: =50
                                    OnChange: =If(Not(IsMatch(Self.Value, Email)), Notify("Invalid email", NotificationType.Warning), Blank())
                                    BorderColor: =If(IsBlank(Self.Value), Color.Red, Color.Gray)
                              - grok_EmailContainer:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    Width: =Parent.Width
                                    Height: =150
                                    LayoutDirection: =LayoutDirection.Vertical
                                  Children:
                                    - grok_Email2Field:
                                        Control: TextInput@0.0.54
                                        Properties:
                                          Value: =grok_selectedCustomer.nc_customeremail2
                                          Mode: ='TextInputCanvas.Mode'.SingleLine
                                          Width: =Parent.Width
                                          Height: =35
                                    # Add Email3Field and Email4Field similarly...
                              - grok_QRContainer:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    Width: =Parent.Width - 20
                                    Height: =40
                                    LayoutDirection: =LayoutDirection.Horizontal
                              - grok_ActiveContainer:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    Width: =Parent.Width - 20
                                    Height: =40
                                    LayoutDirection: =LayoutDirection.Horizontal
                                  Children:
                                    - grok_ActiveToggle:
                                        Control: Toggle@1.1.5
                                        Properties:
                                          Checked: =grok_selectedCustomer.nc_isactive
                                          Width: =Parent.Width - 120
                                          Height: =40
                                          OnUncheck: =UpdateIf(nc_customers, ID = grok_selectedCustomer.ID, {nc_isactive: false})
                                    - grok_ActiveLabel:
                                        Control: Label@2.5.1
                                        Properties:
                                          Text: ="Active Customer"
                                          Width: =120
                                          Height: =40
                                          X: =grok_ActiveToggle.Width
                                          Y: =0
                        - grok_FormControl:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              Height: =40
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutJustifyContent: =LayoutJustifyContent.End
                              PaddingRight: =10
                              PaddingTop: =5
                              Width: =Parent.Width - 6
                              X: =3
                              Y: =Parent.Height - Self.Height - 3
                            Children:
                              - grok_SaveBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    Align: =Align.Center
                                    Appearance: ='ButtonCanvas.Appearance'.Primary
                                    BasePaletteColor: =RGBA(56, 178, 96, 1)
                                    Height: =30
                                    OnSelect: |-
                                      =If(
                                          IsBlank(grok_NameField.UpdatedValue) || IsBlank(grok_Email1Field.Value),
                                          Notify("Name and primary email required", NotificationType.Error),
                                          If(
                                              currentMode = "New",
                                              Patch(
                                                  nc_customers,
                                                  Defaults(nc_customers),
                                                  {
                                                      nc_customername: grok_NameField.UpdatedValue,
                                                      nc_customercode: grok_CodeField.Value,
                                                      nc_region: grok_RegionField.Selected.Value,
                                                      nc_customeremail1: grok_Email1Field.Value,
                                                      nc_isactive: grok_ActiveToggle.Checked,
                                                      nc_qrcodeavailable: grok_QRFlag.Checked
                                                  }
                                              ),
                                              Patch(
                                                  nc_customers,
                                                  grok_selectedCustomer,
                                                  {
                                                      nc_customername: grok_NameField.UpdatedValue
                                                  }
                                              )
                                          )
                                        );
                                        If(
                                            IsEmpty(Errors(nc_customers)),
                                            Notify("Customer saved successfully!", NotificationType.Success);
                                            UpdateContext({currentMode: "View"});
                                            UpdateContext({grok_selectedCustomer: Blank()});
                                            Refresh(nc_customers),
                                            Notify("Error: " & First(Errors(nc_customers)).Message, NotificationType.Error)
                                        )
                                    Text: ="Save"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Width: =80
                              - grok_CancelBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    Align: =Align.Center
                                    BasePaletteColor: =RGBA(128, 128, 128, 1)
                                    Height: =30
                                    OnSelect: |-
                                      =UpdateContext({currentMode: "View"});
                                        UpdateContext({grok_selectedCustomer: Blank()});
                                        Reset(grok_CustomerForm)
                                    Text: ="Cancel"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Width: =80
                        - grok_TransactionsPreview:
                            Control: Gallery@2.15.0
                            Variant: VariableHeight
                            Properties:
                              Items: =Filter(nc_transactions, nc_customer.ID = grok_selectedCustomer.ID, nc_processdate >= DateAdd(Today(), -30, Days))
                              Width: =Parent.Width
                              Height: =100
                              TemplateSize: =60
                              Visible: =!editMode
                              Y: =grok_CustomerForm.Height + 10
                            Children:
                              - grok_TransLabel:
                                  Control: Label@2.5.1
                                  Properties:
                                    Text: =ThisItem.nc_documentnumber & ": " & Text(ThisItem.nc_amountlocalcurrency, "$#,##0.00") & " (" & ThisItem.nc_daycount & " days)"
                                    Width: =Parent.TemplateWidth
                                    AutoHeight: =true
      - grok_NavigationMenu:
          Control: CanvasComponent
          ComponentName: NavigationMenu
          Properties:
            Fill: =RGBA(255, 255, 255, 0.5)
            Height: =Parent.Height - 70
            Visible: =_showMenu
            Width: =260
            Y: =70
            navItems: =Navigation
            navSelected: =currentScreen
      - grok_ConfirmationPopupOverlay:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            Fill: =RGBA(0, 0, 0, 0.5)
            Height: =Parent.Height
            Visible: =showConfirmationPopup
            Width: =Parent.Width
          Children:
            - grok_ConfirmationPopup:
                Control: Rectangle@2.3.0
                Properties:
                  BorderColor: =RGBA(0, 18, 107, 1)
                  Fill: =RGBA(255, 255, 255, 1)
                  Height: =200
                  Width: =400
                  X: =(Parent.Width - Self.Width) / 2
                  Y: =(Parent.Height - Self.Height) / 2
            - grok_ConfirmationText:
                Control: Text@0.0.51
                Properties:
                  Height: =89
                  PaddingBottom: =10
                  PaddingLeft: =10
                  PaddingRight: =10
                  PaddingTop: =10
                  Text: = "Are you sure you want to delete '" & recordPrimaryProperty & "'?"
                  VerticalAlign: =VerticalAlign.Top
                  Width: =400
                  X: =grok_ConfirmationPopup.X
                  Y: =grok_ConfirmationPopup.Y
            - grok_ConfirmationCancelBtn:
                Control: Button@0.0.45
                Properties:
                  OnSelect: |-
                    =UpdateContext({showConfirmationPopup: false});
                    UpdateContext({recordToDelete: Blank()});
                    UpdateContext({recordPrimaryProperty: ""});
                    UpdateContext({dataSourceIdentifier: ""})
                  Text: ="Cancel"
                  X: =grok_ConfirmationPopup.X + grok_ConfirmationPopup.Width - Self.Width - 20
                  Y: =grok_ConfirmationPopup.Y + grok_ConfirmationPopup.Height - Self.Height - 20
            - grok_ConfirmationDeleteBtn:
                Control: Button@0.0.45
                Properties:
                  BasePaletteColor: =RGBA(249, 83, 109, 1)
                  OnSelect: |-
                    =Remove(nc_customers, recordToDelete);
                    UpdateContext({showConfirmationPopup: false});
                    UpdateContext({recordToDelete: Blank()});
                    UpdateContext({recordPrimaryProperty: ""});
                    UpdateContext({dataSourceIdentifier: ""});
                    Refresh(nc_customers);
                    Notify("Customer deleted successfully.", NotificationType.Success)
                  Text: ="Yes, Delete"
                  X: =grok_ConfirmationPopup.X + 20
                  Y: =grok_ConfirmationPopup.Y + grok_ConfirmationPopup.Height - Self.Height - 20
                  Visible: =_isARAdmin