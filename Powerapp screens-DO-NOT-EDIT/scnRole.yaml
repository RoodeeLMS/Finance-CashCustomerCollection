Screens:
  scnRole:
    Properties:
      Fill: =RGBA(243, 242, 241, 1)
      LoadingSpinnerColor: =RGBA(0, 101, 161, 1)
      OnVisible: |-
        =// Check if user is Admin, redirect if not

        // Initialize local variables
        UpdateContext({
            currentScreen: "Role Management",
            _showMenu: false,
            _currentMode: "View",
            _showDeleteConfirmation: false,
            _selectedUser: Blank(),
            _userToDelete: Blank()
        });
    Children:
      - Role_Container:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            DropShadow: =DropShadow.None
            Height: =Parent.Height
            Width: =Parent.Width
          Children:
            - Role_Header:
                Control: GroupContainer@1.3.0
                Variant: AutoLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(0, 101, 161, 1)
                  Height: =55
                  LayoutAlignItems: =LayoutAlignItems.Center
                  LayoutDirection: =LayoutDirection.Horizontal
                  PaddingLeft: =15
                  RadiusBottomLeft: =8
                  RadiusBottomRight: =8
                  RadiusTopLeft: =8
                  RadiusTopRight: =8
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =10
                Children:
                  - Role_MenuIcon:
                      Control: Classic/Icon@2.5.0
                      Properties:
                        Color: =RGBA(255, 255, 255, 1)
                        Height: =50
                        Icon: =Icon.Hamburger
                        OnSelect: |-
                          =UpdateContext({_showMenu: !_showMenu})
                        PaddingBottom: =10
                        PaddingLeft: =10
                        PaddingRight: =10
                        PaddingTop: =10
                        Width: =50
                  - Role_HeaderTitle:
                      Control: Text@0.0.51
                      Properties:
                        Font: =Font.Lato
                        FontColor: =Color.White
                        Height: =50
                        PaddingLeft: =20
                        Size: =25
                        Text: ="User Role Management"
                        VerticalAlign: =VerticalAlign.Middle
                        Weight: ='TextCanvas.Weight'.Medium
                        Width: =Parent.Width - Role_MenuIcon.Width - 40
            - Role_Content:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(255, 255, 255, 1)
                  Height: =Parent.Height - 85
                  RadiusBottomLeft: =10
                  RadiusBottomRight: =10
                  RadiusTopLeft: =10
                  RadiusTopRight: =10
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =75
                Children:
                  - Role_TableView:
                      Control: GroupContainer@1.3.0
                      Variant: ManualLayout
                      Properties:
                        Height: =Parent.Height
                        Visible: =_currentMode = "View"
                        Width: =Parent.Width
                      Children:
                        - Role_ActionBar:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              Fill: =RGBA(245, 245, 245, 1)
                              Height: =50
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutJustifyContent: =LayoutJustifyContent.End
                              PaddingLeft: =15
                              PaddingRight: =15
                              RadiusTopLeft: =10
                              RadiusTopRight: =10
                              Width: =Parent.Width
                            Children:
                              - Role_AddBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    Height: =35
                                    Icon: ="Add"
                                    OnSelect: |-
                                      =UpdateContext({
                                          _currentMode: "New",
                                          _selectedUser: Blank()
                                      })
                                    Text: ="Add User"
                                    Width: =120
                              - Role_EditBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(100, 81, 61, 1)
                                    DisplayMode: |-
                                      =If(
                                          IsBlankOrError(Role_Table.Selected),
                                          DisplayMode.Disabled,
                                          DisplayMode.Edit
                                      )
                                    Height: =35
                                    Icon: ="Edit"
                                    OnSelect: |-
                                      =UpdateContext({
                                          _currentMode: "Edit",
                                          _selectedUser: Role_Table.Selected
                                      })
                                    Text: ="Edit"
                                    Width: =80
                              - Role_DeleteBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(191, 25, 34, 1)
                                    DisplayMode: |-
                                      =If(
                                          IsBlankOrError(Role_Table.Selected),
                                          DisplayMode.Disabled,
                                          DisplayMode.Edit
                                      )
                                    Height: =35
                                    Icon: ="Delete"
                                    OnSelect: |-
                                      =UpdateContext({
                                          _userToDelete: Role_Table.Selected,
                                          _showDeleteConfirmation: true
                                      })
                                    Text: ="Delete"
                                    Width: =90
                        - Role_Table:
                            Control: Table@1.0.278
                            Properties:
                              DateTimeFormat: ='PowerAppsOneGrid.DateTimeFormat'.ShortDate
                              EnableRangeSelection: ='PowerAppsOneGrid.EnableRangeSelection'.Enable
                              Height: =Parent.Height - 60
                              Items: ='[THFinanceCashCollection]RoleAssignments'
                              ReflowBehavior: ='PowerAppsOneGrid.ReflowBehavior'.Reflow
                              ShowAvatar: ="no"
                              Width: =Parent.Width - 20
                              X: =10
                              Y: =55
                            Children:
                              - Email2:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Email"
                                    FieldName: ="cr7bb_email"
                                    FieldType: ="s"
                                    Order: =1
                              - Role2:
                                  Control: TableDataField@1.5.0
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Role"
                                    FieldName: ="cr7bb_Role"
                                    FieldType: ="E"
                                    Order: =2
                  - Role_FormView:
                      Control: GroupContainer@1.3.0
                      Variant: ManualLayout
                      Properties:
                        Height: =Parent.Height
                        Visible: =_currentMode = "New" || _currentMode = "Edit"
                        Width: =Parent.Width
                      Children:
                        - Role_FormContainer:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              Height: =Parent.Height - 50
                              LayoutDirection: =LayoutDirection.Vertical
                              LayoutGap: =15
                              PaddingLeft: =20
                              PaddingRight: =20
                              PaddingTop: =20
                              Width: =Parent.Width
                            Children:
                              - Role_Form_UserLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(100, 100, 100, 1)
                                    Height: =25
                                    Text: ="Select User:"
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width - 40
                              - Role_Form_UserCombo:
                                  Control: ComboBox@0.0.51
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    DefaultSelectedItems: |-
                                      =If(
                                          IsBlank(_selectedUser),
                                          Blank(),
                                          Office365Users.UserProfile(_selectedUser.Email)
                                      )
                                    DisplayMode: |-
                                      =If(
                                          _currentMode = "Edit",
                                          DisplayMode.View,
                                          DisplayMode.Edit
                                      )
                                    Height: =40
                                    Items: |-
                                      =If(
                                          (Len(Self.SearchText) >= 2) || !IsBlankOrError(_selectedUser.Email),
                                          Office365Users.SearchUser({
                                              searchTerm: Self.SearchText,
                                              top: 15
                                          })
                                      )
                                    Width: =Parent.Width - 40
                                  Children:
                                    - DisplayNameField:
                                        Control: ComboBoxDataField@1.5.0
                                        Properties:
                                          FieldDisplayName: ="Display Name"
                                          FieldName: ="DisplayName"
                                          FieldType: ="s"
                              - Role_Form_RoleLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(100, 100, 100, 1)
                                    Height: =25
                                    Text: ="Role:"
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width - 40
                              - Role_Form_RoleCombo:
                                  Control: ComboBox@0.0.51
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    DefaultSelectedItems: =_selectedUser.Role
                                    Height: =40
                                    Items: ='[THFinanceCashCollection]Roles'
                                    Width: =Parent.Width - 40
                                  Children:
                                    - RoleName1:
                                        Control: ComboBoxDataField@1.5.0
                                        Variant: textualColumn
                                        IsLocked: true
                                        Properties:
                                          FieldDisplayName: ="RoleName"
                                          FieldName: ="cr7bb_rolename"
                                          FieldType: ="s"
                                          Order: =1
                        - Role_FormActionBar:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              Fill: =RGBA(245, 245, 245, 1)
                              Height: =50
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutJustifyContent: =LayoutJustifyContent.End
                              PaddingRight: =15
                              Width: =Parent.Width
                              Y: =Parent.Height - Self.Height
                            Children:
                              - Role_Form_SaveBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    Height: =35
                                    Icon: ="Save"
                                    OnSelect: |-
                                      =If(
                                          _currentMode = "New",
                                          Patch(
                                              '[THFinanceCashCollection]RoleAssignments',
                                              Defaults('[THFinanceCashCollection]RoleAssignments'),
                                              {
                                                  AssignmentKey: Role_Form_UserCombo.Selected.DisplayName & "-" & Role_Form_RoleCombo.Selected.RoleName,
                                                  UserName: Role_Form_UserCombo.Selected.DisplayName,
                                                  Email: Role_Form_UserCombo.Selected.Mail,
                                                  Role: Role_Form_RoleCombo.Selected
                                              }
                                          ),
                                          Patch(
                                              '[THFinanceCashCollection]RoleAssignments',
                                              _selectedUser,
                                              {
                                                  AssignmentKey: Role_Form_UserCombo.Selected.DisplayName & "-" & Role_Form_RoleCombo.Selected.RoleName,
                                                  UserName: Role_Form_UserCombo.Selected.DisplayName,
                                                  Role: Role_Form_RoleCombo.Selected
                                              }
                                          )
                                      );
                                      If(
                                          IsEmpty(Errors('[THFinanceCashCollection]RoleAssignments')),
                                          Notify("User saved successfully", NotificationType.Success);
                                          UpdateContext({_currentMode: "View"}),
                                          Notify("Error saving user: " & First(Errors('[THFinanceCashCollection]RoleAssignments')).Message, NotificationType.Error)
                                      )
                                    Text: =If(_currentMode = "New", "Add", "Save")
                                    Width: =90
                              - Role_Form_CancelBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(100, 100, 100, 1)
                                    Height: =35
                                    Icon: ="Cancel"
                                    OnSelect: |-
                                      =UpdateContext({_currentMode: "View"})
                                    Text: ="Cancel"
                                    Width: =90
            - Role_NavigationMenu:
                Control: CanvasComponent
                ComponentName: NavigationMenu
                Properties:
                  Fill: =RGBA(255, 255, 255, 0.5)
                  Height: =Parent.Height - 70
                  Visible: =If(_showMenu, true, false)
                  Width: =260
                  Y: =70
                  navItems: =Navigation
                  navSelected: =currentScreen
            - Role_DeleteConfirmationOverlay:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  Fill: =RGBA(0, 0, 0, 0.5)
                  Height: =Parent.Height
                  Visible: =_showDeleteConfirmation
                  Width: =Parent.Width
                Children:
                  - Role_DeleteConfirmationBox:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.Regular
                        Fill: =RGBA(255, 255, 255, 1)
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutGap: =20
                        PaddingBottom: =20
                        PaddingLeft: =20
                        PaddingRight: =20
                        PaddingTop: =20
                        RadiusBottomLeft: =10
                        RadiusBottomRight: =10
                        RadiusTopLeft: =10
                        RadiusTopRight: =10
                        Width: =400
                        X: =(Parent.Width - Self.Width) / 2
                        Y: =(Parent.Height - Self.Height) / 2
                      Children:
                        - Role_DeleteConfirmationText:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 0, 0, 1)
                              Height: =80
                              Size: =16
                              Text: ="Are you sure you want to delete '" & _userToDelete.UserName & "' (" & _userToDelete.Email & ")?"
                              VerticalAlign: =VerticalAlign.Top
                              Weight: ='TextCanvas.Weight'.Semibold
                              Width: =360
                        - Role_DeleteConfirmationButtons:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutJustifyContent: =LayoutJustifyContent.End
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =360
                            Children:
                              - Role_DeleteConfirmBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(191, 25, 34, 1)
                                    Height: =35
                                    Icon: ="Delete"
                                    OnSelect: |-
                                      =Remove('[THFinanceCashCollection]RoleAssignments', _userToDelete);
                                      Notify("User deleted successfully", NotificationType.Success);
                                      UpdateContext({
                                          _showDeleteConfirmation: false,
                                          _userToDelete: Blank()
                                      });
                                      Refresh('[THFinanceCashCollection]RoleAssignments')
                                    Text: ="Yes, Delete"
                                    Width: =120
                              - Role_DeleteCancelBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(100, 100, 100, 1)
                                    Height: =35
                                    Icon: ="Cancel"
                                    OnSelect: |-
                                      =UpdateContext({
                                          _showDeleteConfirmation: false,
                                          _userToDelete: Blank()
                                      })
                                    Text: ="Cancel"
                                    Width: =90
