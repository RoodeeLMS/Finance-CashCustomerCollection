Screens:
  scnTransactions:
    Properties:
      Fill: =RGBA(243, 242, 241, 1)
      LoadingSpinnerColor: =RGBA(0, 101, 161, 1)
      OnVisible: |
        =// Batch local variables with UpdateContext
        UpdateContext({
            currentScreen: "Transactions",
            _showMenu: false,
            _selectedCustomer: Blank(),
            _dateTo: Today(),
            _typeFilter: "All",
            _statusFilter: "All"
        });

        // Load customers for filter dropdown
        ClearCollect(
            colCustomers,
            Sort('[THFinanceCashCollection]Customers', cr7bb_customername, SortOrder.Ascending)
        );
    Children:
      - Trans_Container:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            DropShadow: =DropShadow.None
            Height: =Parent.Height
            Width: =Parent.Width
          Children:
            - Trans_Header:
                Control: GroupContainer@1.3.0
                Variant: AutoLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(0, 101, 161, 1)
                  Height: =55
                  LayoutAlignItems: =LayoutAlignItems.Center
                  LayoutDirection: =LayoutDirection.Horizontal
                  PaddingLeft: =15
                  RadiusBottomLeft: =8
                  RadiusBottomRight: =8
                  RadiusTopLeft: =8
                  RadiusTopRight: =8
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =10
                Children:
                  - Trans_MenuIcon:
                      Control: Classic/Icon@2.5.0
                      Properties:
                        Color: =RGBA(255, 255, 255, 1)
                        Height: =50
                        Icon: =Icon.Hamburger
                        OnSelect: |-
                          =UpdateContext({_showMenu: !_showMenu})
                        PaddingBottom: =10
                        PaddingLeft: =10
                        PaddingRight: =10
                        PaddingTop: =10
                        Width: =50
                  - Trans_HeaderTitle:
                      Control: Text@0.0.51
                      Properties:
                        Font: =Font.Lato
                        FontColor: =Color.White
                        Height: =50
                        PaddingLeft: =20
                        Size: =25
                        Text: ="Transaction Management"
                        VerticalAlign: =VerticalAlign.Middle
                        Weight: ='TextCanvas.Weight'.Medium
                        Width: =Parent.Width - Trans_MenuIcon.Width - 40
            - Trans_Content:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(255, 255, 255, 1)
                  Height: =Parent.Height - 85
                  RadiusBottomLeft: =10
                  RadiusBottomRight: =10
                  RadiusTopLeft: =10
                  RadiusTopRight: =10
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =75
                Children:
                  - Trans_FilterSection:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(245, 245, 245, 1)
                        Height: =140
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutGap: =10
                        PaddingBottom: =10
                        PaddingLeft: =15
                        PaddingRight: =15
                        PaddingTop: =10
                        RadiusTopLeft: =10
                        RadiusTopRight: =10
                        Width: =Parent.Width
                      Children:
                        - Trans_FilterRow1:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - Trans_CustomerLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: ="Customer:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =100
                              - Trans_CustomerCombo:
                                  Control: ComboBox@0.0.51
                                  Properties:
                                    DefaultSelectedItems: =[]
                                    Height: =40
                                    InputTextPlaceholder: ="All Customers"
                                    Items: =colCustomers
                                    OnChange: |-
                                      =UpdateContext({
                                          _selectedCustomer: 
                                          If(
                                              CountRows(Self.SelectedItems) > 0,
                                              First(Self.SelectedItems),
                                              Blank()
                                          )
                                      });
                                    Width: =300
                                  Children:
                                    - CustomerName:
                                        Control: ComboBoxDataField@1.5.0
                                        Variant: textualColumn
                                        Properties:
                                          FieldDisplayName: ="Customer Name"
                                          FieldName: ="cr7bb_customername"
                                          FieldType: ="s"
                                          Order: =1
                              - Trans_TypeLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: ="Type:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =60
                              - Trans_TypeDropdown:
                                  Control: DropDown@0.0.45
                                  Properties:
                                    DefaultSelectedItems: =["All"]
                                    Height: =40
                                    Items: =["All", "CN", "DN"]
                                    OnChange: |-
                                      =UpdateContext({
                                          _typeFilter: Self.Selected.Value
                                      });
                                    Width: =120
                              - Trans_StatusLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: ="Status:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =60
                              - Trans_StatusDropdown:
                                  Control: DropDown@0.0.45
                                  Properties:
                                    DefaultSelectedItems: =["All"]
                                    Height: =40
                                    Items: =["All", "Processed", "Unprocessed"]
                                    OnChange: |-
                                      =UpdateContext({
                                          _statusFilter: Self.Selected.Value
                                      });
                                    Width: =140
                        - Trans_FilterRow2:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - Trans_DateLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: ="Process Date:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =100
                              - Trans_DateTo:
                                  Control: DatePicker@0.0.46
                                  Properties:
                                    Height: =40
                                    OnChange: |-
                                      =UpdateContext({
                                          _dateTo: Self.SelectedDate
                                      });
                                    SelectedDate: =_dateTo
                                    Width: =180
                        - Trans_FilterRow3:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - Trans_FilterInfo:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(100, 100, 100, 1)
                                    Height: =35
                                    Text: |-
                                      ="Records: " & CountRows(Filter(Trans_Gallery.AllItems,
                                          (_typeFilter = "All" ||
                                              (_typeFilter = "CN" && cr7bb_transactiontype = 'Transaction Type Choice'.'Credit Note') ||
                                              (_typeFilter = "DN" && cr7bb_transactiontype = 'Transaction Type Choice'.'Debit Note'))
                                      ))
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Regular
                                    Width: =250
                              - Trans_TotalLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =35
                                    Size: =16
                                    Text: |-
                                      ="Total: ฿" & Text(
                                          Sum(Filter(Trans_Gallery.AllItems,
                                              (_typeFilter = "All" ||
                                                  (_typeFilter = "CN" && cr7bb_transactiontype = 'Transaction Type Choice'.'Credit Note') ||
                                                  (_typeFilter = "DN" && cr7bb_transactiontype = 'Transaction Type Choice'.'Debit Note'))
                                          ),
                                              cr7bb_amountlocalcurrency
                                          ),
                                          "#,##0.00"
                                      )
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Bold
                                    Width: =300
                  - Trans_TableSection:
                      Control: GroupContainer@1.3.0
                      Variant: ManualLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =Parent.Height - 460
                        Width: =Parent.Width - 20
                        X: =10
                        Y: =150
                      Children:
                        - Trans_ActionBar:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              Fill: =RGBA(250, 250, 250, 1)
                              Height: =50
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              PaddingLeft: =15
                              PaddingRight: =15
                              Width: =Parent.Width
                            Children:
                              - Trans_MarkProcessedBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    DisplayMode: |-
                                      =If(
                                          CountRows(Trans_Table.SelectedItems) = 0,
                                          DisplayMode.Disabled,
                                          DisplayMode.Edit
                                      )
                                    Height: =35
                                    Icon: ="CheckmarkCircle"
                                    OnSelect: |
                                      =ForAll(
                                          DropColumns(Trans_Table.SelectedItems, TransactionTypeText, AmountFormatted),
                                          Patch(
                                              '[THFinanceCashCollection]Transactions',
                                              ThisRecord,
                                              {cr7bb_isprocessed: true}
                                          )
                                      );
                                      Notify(
                                          CountRows(Trans_Table.SelectedItems) & " transactions marked as processed",
                                          NotificationType.Success
                                      );
                                    Text: ="Mark Processed"
                                    Width: =170
                              - Trans_ExportBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(100, 81, 61, 1)
                                    Height: =35
                                    Icon: ="DocumentAdd"
                                    OnSelect: =Notify("Export functionality not yet implemented", NotificationType.Information)
                                    Text: ="Export to Excel"
                                    Width: =150
                        - Trans_Gallery:
                            Control: Gallery@2.15.0
                            Variant: Vertical
                            Properties:
                              BorderColor: =RGBA(0, 18, 107, 1)
                              Height: =106
                              Items: |+
                                =With({
                                    FilterTable: 
                                        Filter(
                                            '[THFinanceCashCollection]Transactions',
                                            (IsBlank(_selectedCustomer) || Customer.'[THFinanceCashCollection]Customer' = _selectedCustomer.'[THFinanceCashCollection]Customer') &&
                                            cr7bb_transactionprocessdate >= _dateTo && cr7bb_transactionprocessdate < DateAdd(_dateTo, 1, TimeUnit.Days) &&
                                            (_statusFilter = "All" ||
                                                (_statusFilter = "Processed" && cr7bb_isprocessed = true) ||
                                                (_statusFilter = "Unprocessed" && cr7bb_isprocessed = false))
                                        )
                                    },
                                    SortByColumns(
                                        AddColumns(
                                            FilterTable,
                                            TransactionTypeText,
                                            If(
                                                cr7bb_transactiontype = 'Transaction Type Choice'.'Credit Note',
                                                "CN",
                                                If(
                                                    cr7bb_transactiontype = 'Transaction Type Choice'.'Debit Note',
                                                    "DN",
                                                    ""
                                                )
                                            ),
                                            AmountFormatted,
                                            "฿" & Text(cr7bb_amountlocalcurrency, "#,##0.00")
                                        ),
                                        "cr7bb_documentdate",
                                        SortOrder.Ascending
                                    )
                                )

                              Visible: =false
                              Width: =604
                        - Trans_Table:
                            Control: Table@1.0.278
                            Properties:
                              Height: =Parent.Height - 60
                              Items: |-
                                =Filter(Trans_Gallery.AllItems,
                                    (_typeFilter = "All" ||
                                        (_typeFilter = "CN" && cr7bb_transactiontype = 'Transaction Type Choice'.'Credit Note') ||
                                        (_typeFilter = "DN" && cr7bb_transactiontype = 'Transaction Type Choice'.'Debit Note'))
                                )
                              Width: =Parent.Width
                              Y: =50
                            Children:
                              - Trans_TypeColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Type"
                                    FieldName: ="TransactionTypeText"
                                    FieldType: ="s"
                                    Order: =1
                              - Trans_DocumentColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Document"
                                    FieldName: ="cr7bb_documentnumber"
                                    FieldType: ="s"
                                    Order: =2
                              - Trans_DateColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Date"
                                    FieldName: ="cr7bb_documentdate"
                                    FieldType: ="d"
                                    Order: =3
                              - Trans_DaysColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Days"
                                    FieldName: ="cr7bb_daycount"
                                    FieldType: ="n"
                                    Order: =4
                              - Trans_AmountColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Amount"
                                    FieldName: ="AmountFormatted"
                                    FieldType: ="s"
                                    Order: =5
                                    Width: =120
                              - Trans_NoteColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Note"
                                    FieldName: ="cr7bb_textfield"
                                    FieldType: ="s"
                                    Order: =6
                              - Trans_ProcessedColumn:
                                  Control: TableDataField@1.5.0
                                  Variant: textualColumn
                                  IsLocked: true
                                  Properties:
                                    FieldDisplayName: ="Processed"
                                    FieldName: ="cr7bb_isprocessed"
                                    FieldType: ="b"
                                    Order: =7
                  - Trans_FIFOPreview:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =280
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutGap: =10
                        PaddingBottom: =15
                        PaddingLeft: =15
                        PaddingRight: =15
                        PaddingTop: =15
                        RadiusBottomLeft: =8
                        RadiusBottomRight: =8
                        RadiusTopLeft: =8
                        RadiusTopRight: =8
                        Width: =Parent.Width - 20
                        X: =10
                        Y: =Parent.Height - 290
                      Children:
                        - Trans_FIFOTitle:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 0, 0, 1)
                              Height: =30
                              Size: =16
                              Text: ="FIFO Calculation Preview"
                              VerticalAlign: =VerticalAlign.Middle
                              Weight: ='TextCanvas.Weight'.Bold
                              Width: =Parent.Width - 30
                        - Trans_FIFOCustomer:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 0, 0, 1)
                              Height: =25
                              Text: |-
                                =If(
                                    IsBlank(_selectedCustomer),
                                    "Customer: All customers selected",
                                    "Customer: " & _selectedCustomer.cr7bb_customername
                                )
                              VerticalAlign: =VerticalAlign.Middle
                              Weight: ='TextCanvas.Weight'.Semibold
                              Width: =Parent.Width - 30
                        - Trans_FIFOSummary:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              Fill: =RGBA(245, 245, 245, 1)
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =20
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              PaddingBottom: =10
                              PaddingLeft: =10
                              PaddingRight: =10
                              PaddingTop: =10
                              RadiusBottomLeft: =5
                              RadiusBottomRight: =5
                              RadiusTopLeft: =5
                              RadiusTopRight: =5
                              Width: =Parent.Width - 30
                            Children:
                              - Trans_CNTotal:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 128, 0, 1)
                                    Height: =25
                                    Text: |-
                                      ="CN Total: ฿" & Text(
                                          Sum(Filter(Trans_Gallery.AllItems, cr7bb_transactiontype = 'Transaction Type Choice'.'Credit Note'),
                                              cr7bb_amountlocalcurrency
                                          ),
                                          "#,##0.00"
                                      )
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =200
                              - Trans_DNTotal:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(191, 25, 34, 1)
                                    Height: =25
                                    Text: |-
                                      ="DN Total: ฿" & Text(
                                          Sum(Filter(Trans_Gallery.AllItems, cr7bb_transactiontype = 'Transaction Type Choice'.'Debit Note'),
                                              cr7bb_amountlocalcurrency
                                          ),
                                          "#,##0.00"
                                      )
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =200
                        - Trans_FIFOLogic:
                            Control: Text@0.0.51
                            Properties:
                              AutoHeight: =true
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 0, 0, 1)
                              Size: =13
                              Text: |-
                                =If(
                                    IsBlank(_selectedCustomer),
                                    "Select a customer from the filter above to see FIFO calculation details.",
                                    "FIFO Application:" & Char(10) &
                                    "1. Sort CN and DN by document date (oldest first)" & Char(10) &
                                    "2. Apply CN to DN until CN exhausted" & Char(10) &
                                    "3. Calculate remaining DN balances" & Char(10) &
                                    "4. Determine max day count for template selection"
                                )
                              VerticalAlign: =VerticalAlign.Top
                              Weight: ='TextCanvas.Weight'.Regular
                              Width: =Parent.Width - 30
                        - Trans_NetOwed:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 0, 0, 1)
                              Height: =30
                              Size: =16
                              Text: |-
                                ="Net Owed: ฿" & Text(
                                    Sum(Trans_Gallery.AllItems,
                                        cr7bb_amountlocalcurrency
                                    ),
                                    "#,##0.00"
                                )
                              VerticalAlign: =VerticalAlign.Middle
                              Weight: ='TextCanvas.Weight'.Bold
                              Width: =Parent.Width - 30
            - Trans_NavigationMenu:
                Control: CanvasComponent
                ComponentName: NavigationMenu
                Properties:
                  Fill: =RGBA(255, 255, 255, 0.5)
                  Height: =Parent.Height - 70
                  Visible: =If(_showMenu, true, false)
                  Width: =260
                  Y: =70
                  navItems: =Navigation
                  navSelected: =currentScreen
