# Screen Description: scnEmailApproval (v2.0)

**Created**: 2025-10-11
**Updated**: 2026-01-21
**Status**: Ready for Implementation
**Data Source**: Dataverse
**Template to Use**: template-table-view.yaml
**Language**: English only

---

## Change Log

| Version | Date | Changes |
|---------|------|---------|
| v1.0 | 2025-10-11 | Original with manual approval workflow |
| v2.0 | 2026-01-21 | **MAJOR UPDATE**: Emails are AUTO-APPROVED by Email Engine. Screen renamed to "Email Review & Send Status". Focus on monitoring, not approval. |

---

## CRITICAL: System Architecture

### Daily Flow Sequence
```
07:00 -- SAP Import Flow ------------------------------------+
         - Creates ProcessLog record                         |
         - Imports transactions from Power BI                |
         - Data already filtered at source                   |
                                                             |
07:30 -- Email Engine Flow ----------------------------------+
         - Creates EmailLog records (one per customer)       |
         - AUTO-APPROVES all emails at creation:             |
           * ApprovalStatus = Approved (676180001)           |
           * SendStatus = Pending (676180002)                |
         - Selects template (D->C->B->A priority)            |
                                                             |
08:00 -- Email Sending Flow ---------------------------------+
         - Queries: ApprovalStatus=Approved, SendStatus=Pending
         - Sends emails via Office 365
         - Updates SendStatus to Success/Failed
         - Updates SentDateTime
```

### Key Behaviors
| Behavior | Details |
|----------|---------|
| **Auto-Approve** | Email Engine sets ApprovalStatus = Approved (676180001) directly at creation |
| **No Manual Approval** | There is NO pending approval queue - all emails are pre-approved |
| **Exclusion at Source** | Exclusions applied at Power BI level before import |
| **Template Selection** | D (has MI) -> C (Day 4+) -> B (Day 3) -> A (Day 1-2) |

---

## 1. Purpose & Overview

**What this screen does**:
This screen displays emails generated by the Email Engine for review and send status monitoring. **Emails are AUTO-APPROVED at creation** - this screen is for reviewing content and tracking send status, not for approval.

**Who uses it**:
- **AR Team Member** - Reviews generated emails before 08:00 send time
- **AR Manager** - Monitors send status, handles failed emails
- **System Admin** - Troubleshoots email delivery issues

**User Goals**:
- Review email content before they go out (before 08:00)
- Preview email content, recipient, amounts for each customer
- Manually exclude specific customers if needed
- Track send status (Pending -> Success/Failed)
- Resend failed emails

**NOTE**: This is a REVIEW and MONITORING screen, not an approval screen.

---

## 2. Design Mockup

**Visual Layout**:

```
+------------------------------------------------------------------+
| [=] Email Review & Send Status                          [Refresh] |
+------------------------------------------------------------------+
| FILTER BAR                                                        |
| Date: [21/01/2026 (Today)]  Customers: 97                        |
| [Refresh]  Auto-Approve: ON (System Default)                     |
+------------------------------------------------------------------+
| SPLIT VIEW                                                        |
| +-----------------------------+--------------------------------+ |
| | EMAIL LIST (W:50%)          | EMAIL PREVIEW (W:50%)          | |
| | Gallery@2.15.0              |                                 | |
| |                             | Customer: ABC Corporation       | |
| | ABC Corporation             | To: customer@abc.com            | |
| |   Amount: B125,000          | CC: sales@nestle.com            | |
| |   Transactions: 5 DNs       | Subject: Payment Reminder...    | |
| |   Template: B (Day 3)       | ------------------------------ | |
| |   Status: [Approved]        | Dear ABC Corporation,           | |
| |   Send: [Pending]           |                                 | |
| |                             | Your outstanding balance...     | |
| | XYZ Trading Ltd             |                                 | |
| |   Amount: B89,500           | [Transaction Details Table]     | |
| |   Transactions: 3 DNs       |                                 | |
| |   Template: A (Day 1)       | Total: B125,000 THB             | |
| |   Status: [Approved]        |                                 | |
| |   Send: [Success]           | Payment Instructions...         | |
| +-----------------------------+--------------------------------+ |
+------------------------------------------------------------------+
| ACTION BAR                                                        |
| Emails: 97 | Sent: 82 | Failed: 2 | Pending: 13                  |
|                    [Exclude Selected] [Resend Failed]            |
+------------------------------------------------------------------+
```

---

## 3. Database Schema

**Data Source**: Dataverse

### Primary Entity

**Name**: `[THFinanceCashCollection]Emaillogs`

**Fields Used**:
| Field Display Name | Logical Name | Type | Notes |
|--------------------|--------------|------|-------|
| Email Log ID | cr7bb_thfinancecashcollectionemaillogid | GUID | Primary Key |
| Customer | cr7bb_customer | Lookup | Customer reference |
| Process Date | cr7bb_processdate | Text | "yyyy-mm-dd" format |
| Email Subject | cr7bb_emailsubject | Text(500) | Preview subject line |
| Email Template | cr7bb_emailtemplate | Text | A, B, C, D |
| Max Day Count | cr7bb_maxdaycount | Number | Highest day count |
| Total Amount | cr7bb_totalamount | Currency | Amount owed |
| Transaction Count | cr7bb_transactioncount | Number | DN count |
| Recipient Emails | cr7bb_recipientemails | Text(1000) | To: addresses |
| CC Emails | cr7bb_ccemails | Text(1000) | CC: addresses |
| Sent Date Time | cr7bb_sentdatetime | DateTime | When email was sent |
| **Approval Status** | cr7bb_approvalstatus | Choice | **Always Approved (676180001)** |
| **Send Status** | cr7bb_sendstatus | Choice | Pending/Success/Failed |
| Error Message | cr7bb_errormessage | Text(500) | Error details if failed |

### Choice Field Values

**Approval Status** (`ApprovalStatusChoice`):
| Value | Label | Numeric |
|-------|-------|---------|
| `ApprovalStatusChoice.Pending` | Pending | 676180000 |
| `ApprovalStatusChoice.Approved` | Approved | 676180001 |
| `ApprovalStatusChoice.Rejected` | Rejected | 676180002 |

**Send Status** (`'Send Status Choice'`):
| Value | Label | Numeric |
|-------|-------|---------|
| `'Send Status Choice'.Success` | Success | 676180000 |
| `'Send Status Choice'.Failed` | Failed | 676180001 |
| `'Send Status Choice'.Pending` | Pending | 676180002 |

### Critical Syntax Patterns

```powerfx
// Approval Status (all emails are Approved at creation)
cr7bb_approvalstatus = ApprovalStatusChoice.Approved

// Send Status - use quotes around name with spaces
cr7bb_sendstatus = 'Send Status Choice'.Pending
cr7bb_sendstatus = 'Send Status Choice'.Success
cr7bb_sendstatus = 'Send Status Choice'.Failed
```

---

## 4. Features & Functionality

### 4.1 Filter Bar Features

**Date Display**:
- Default: `Today()`
- Filter: Only show Emaillogs where `cr7bb_processdate = Text(_filterDate, "yyyy-mm-dd")`
- Note: `cr7bb_processdate` is TEXT type, not Date

**Status Summary**:
- Total: `CountRows(colEmails)`
- Sent: `CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Success))`
- Failed: `CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Failed))`
- Pending: `CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Pending))`

**Auto-Approve Indicator**:
- Display: "Auto-Approve: ON (System Default)"
- Read-only indicator showing system behavior
- No toggle needed (auto-approve is built into Email Engine)

### 4.2 Email Gallery

**Data Source**:
```powerfx
colEmails = SortByColumns(
    Filter(
        '[THFinanceCashCollection]Emaillogs',
        cr7bb_processdate = Text(_filterDate, "yyyy-mm-dd")
    ),
    "cr7bb_maxdaycount", SortOrder.Descending,
    "cr7bb_totalamount", SortOrder.Descending
)
```

**Gallery Layout** (Template Height: 130):
- **Customer Info** (main area):
  - Customer Name (via lookup)
  - Amount: `Text(ThisItem.cr7bb_totalamount, "B#,##0.00") & " THB"`
  - Transaction Count: `ThisItem.cr7bb_transactioncount & " DNs"`
  - Template: `"Template " & ThisItem.cr7bb_emailtemplate & " (Day " & ThisItem.cr7bb_maxdaycount & ")"`
- **Status Badges** (right):
  - Approval Badge: Always green "Approved"
  - Send Status Badge:
    - Pending: Gray
    - Success: Green
    - Failed: Red
- **View Button**: Opens preview panel

### 4.3 Email Preview Panel

**Visibility**: `!IsBlank(_selectedEmail)`

**Preview Sections**:

1. **Header Info**:
   - Customer Name (via lookup)
   - To: `_selectedEmail.cr7bb_recipientemails`
   - CC: `_selectedEmail.cr7bb_ccemails`
   - Subject: `_selectedEmail.cr7bb_emailsubject`
   - Template: `"Template " & _selectedEmail.cr7bb_emailtemplate`

2. **Transaction Detail Gallery**:
   ```powerfx
   Items = Filter(
       '[THFinanceCashCollection]Transactions',
       cr7bb_customer = _selectedEmail.cr7bb_customer &&
       cr7bb_processdate = _selectedEmail.cr7bb_processdate
   )
   ```

3. **Total Section**:
   - Total Amount: `_selectedEmail.cr7bb_totalamount`

### 4.4 Action Bar

**Summary Display**:
```powerfx
="Emails: " & CountRows(colEmails) &
" | Sent: " & CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Success)) &
" | Failed: " & CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Failed)) &
" | Pending: " & CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Pending))
```

**Exclude Selected Button**:
- Appearance: Secondary
- Icon: "Cancel"
- Enabled: `CountRows(colSelectedEmails) > 0`
- OnSelect:
  ```powerfx
  ForAll(
      colSelectedEmails,
      Patch(
          '[THFinanceCashCollection]Emaillogs',
          LookUp('[THFinanceCashCollection]Emaillogs',
              cr7bb_thfinancecashcollectionemaillogid = ThisRecord.cr7bb_thfinancecashcollectionemaillogid),
          {
              cr7bb_sendstatus: 'Send Status Choice'.Failed,
              cr7bb_errormessage: "Manually excluded by AR team"
          }
      )
  );
  Notify("Excluded " & CountRows(colSelectedEmails) & " emails", NotificationType.Success);
  Clear(colSelectedEmails);
  Set(_refreshTrigger, !_refreshTrigger)
  ```

**Resend Failed Button**:
- Appearance: Primary (Nestle Blue)
- Icon: "Send"
- Visible: `CountRows(Filter(colEmails, cr7bb_sendstatus = 'Send Status Choice'.Failed)) > 0`
- OnSelect: Triggers Manual Email Resend flow

---

## 5. Behavior & Logic

### 5.1 OnVisible (Screen Load)

```powerfx
UpdateContext({currentScreen: "Email Approval"});
Set(_showMenu, false);
Set(_isLoading, true);
Set(_filterDate, Today());
Set(_showPreview, false);
Set(_selectedEmail, Blank());
Set(_refreshTrigger, false);

// Load emails for today
ClearCollect(
    colEmails,
    SortByColumns(
        Filter(
            '[THFinanceCashCollection]Emaillogs',
            cr7bb_processdate = Text(_filterDate, "yyyy-mm-dd")
        ),
        "cr7bb_maxdaycount", SortOrder.Descending,
        "cr7bb_totalamount", SortOrder.Descending
    )
);

Clear(colSelectedEmails);
Set(_isLoading, false);
```

### 5.2 Gallery Items (with refresh trigger)

```powerfx
=If(
    _refreshTrigger || !_refreshTrigger,
    SortByColumns(
        Filter(
            '[THFinanceCashCollection]Emaillogs',
            cr7bb_processdate = Text(_filterDate, "yyyy-mm-dd")
        ),
        "cr7bb_maxdaycount", SortOrder.Descending,
        "cr7bb_totalamount", SortOrder.Descending
    )
)
```

---

## 6. Navigation Integration

**From**:
- scnDashboard (Review Emails button)
- scnDashboard (View Failed button)

**To**:
- scnDashboard (nav menu)
- scnCustomer (nav menu)
- scnCustomerHistory (view customer details)

---

## 7. Styling & Branding

### Nestle Brand Colors

- **Header Fill**: RGBA(0, 101, 161, 1) - Nestle Blue
- **Primary Button**: RGBA(0, 101, 161, 1) - Nestle Blue
- **Success Badge**: RGBA(16, 124, 16, 1) - Green
- **Failed Badge**: RGBA(168, 0, 0, 1) - Red
- **Pending Badge**: RGBA(150, 150, 150, 1) - Gray
- **Approved Badge**: RGBA(0, 128, 96, 1) - Teal

### Send Status Color Coding

| Status | Color | Meaning |
|--------|-------|---------|
| Success | Green | Email delivered |
| Failed | Red | Send error (click for details) |
| Pending | Gray | Waiting for 08:00 send |

---

## 8. Important Notes

### Why There's No Approval Toggle

The original design included a manual approval workflow, but the **actual Email Engine flow AUTO-APPROVES all emails** at creation time:

```yaml
cr7bb_approvalstatus: 676180001     # Approved (AUTO-APPROVED)
cr7bb_sendstatus: 676180002         # Pending (waiting for send)
```

This means:
1. All emails shown in this screen are already approved
2. The screen is for REVIEW and MONITORING, not approval
3. Users can still EXCLUDE customers before 08:00 if needed
4. Failed emails can be resent manually

### Screen Rename Suggestion

Consider renaming from "Email Approval" to:
- "Email Review & Send Status"
- "Daily Email Monitor"
- "Email Send Status"

---

## 9. Success Criteria

### Functional Requirements

- [ ] Load all emails for selected date
- [ ] Display customer info, amount, transaction count, template type
- [ ] Show send status (Success/Failed/Pending) clearly
- [ ] Preview full email content including transaction table
- [ ] Exclude selected emails from sending (before 08:00)
- [ ] Trigger resend for failed emails
- [ ] Track status summary (total/sent/failed/pending)

### Performance Requirements

- [ ] Load <100 emails within 2 seconds
- [ ] Preview panel updates <500ms when clicking item
- [ ] Exclude action completes within 5 seconds

### User Experience Requirements

- [ ] Clear visual distinction between Success/Failed/Pending status
- [ ] Status counter shows total breakdown
- [ ] Preview panel shows complete email content
- [ ] Confirmation notification after actions
- [ ] Error details shown for failed emails

---

## 10. Testing Scenarios

### Before 08:00 (Pending emails)

1. **Scenario**: AR team opens screen at 7:45 AM
   - Expected: See emails with SendStatus = Pending
   - Action: Review email content
   - Optional: Exclude problematic customers

### After 08:00 (Mixed status)

1. **Scenario**: AR team opens screen at 9:00 AM
   - Expected: See mix of Success/Failed/Pending
   - Action: Click failed emails to view error
   - Action: Click "Resend Failed" if needed

### Error Handling

1. **Scenario**: Email send failed due to invalid address
   - Expected: Red "Failed" badge visible
   - Action: Click email to see error message
   - Action: Contact customer to update email

---

**READY FOR IMPLEMENTATION**
