Screens:
  scnEmailMonitor:
    Properties:
      Fill: =RGBA(243, 242, 241, 1)
      LoadingSpinnerColor: =RGBA(0, 101, 161, 1)
      OnVisible: |-
        =// Batch local variables with UpdateContext
        UpdateContext({
            currentScreen: "Email Monitor",
            _showMenu: false,
            _filterDate: If(!IsBlank(gblFilterDate), gblFilterDate, Today()),
            _statusFilter: If(!IsBlank(gblEmailStatusFilter), gblEmailStatusFilter, "All"),
            _selectedCustomer: Blank(),
            _selectedEmail: If(!IsBlank(gblSelectedEmail), gblSelectedEmail, Blank()),
            _refreshTrigger: false
        });

        // Data operations
        ClearCollect(
            colCustomers,
            Sort('[THFinanceCashCollection]Customers', cr7bb_customername, SortOrder.Ascending)
        );
    Children:
      - EmailMon_Container:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            DropShadow: =DropShadow.None
            Height: =Parent.Height
            Width: =Parent.Width
          Children:
            - EmailMon_Header:
                Control: GroupContainer@1.3.0
                Variant: AutoLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(0, 101, 161, 1)
                  Height: =55
                  LayoutAlignItems: =LayoutAlignItems.Center
                  LayoutDirection: =LayoutDirection.Horizontal
                  PaddingLeft: =15
                  RadiusBottomLeft: =8
                  RadiusBottomRight: =8
                  RadiusTopLeft: =8
                  RadiusTopRight: =8
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =10
                Children:
                  - EmailMon_MenuIcon:
                      Control: Classic/Icon@2.5.0
                      Properties:
                        Color: =RGBA(255, 255, 255, 1)
                        Height: =50
                        Icon: =Icon.Hamburger
                        OnSelect: =Set(_showMenu, !_showMenu)
                        PaddingBottom: =10
                        PaddingLeft: =10
                        PaddingRight: =10
                        PaddingTop: =10
                        Width: =50
                  - EmailMon_HeaderTitle:
                      Control: Text@0.0.51
                      Properties:
                        Font: =Font.Lato
                        FontColor: =Color.White
                        Height: =50
                        PaddingLeft: =20
                        Size: =25
                        Text: ="Email Monitor"
                        VerticalAlign: =VerticalAlign.Middle
                        Weight: ='TextCanvas.Weight'.Medium
                        Width: =Parent.Width - EmailMon_MenuIcon.Width - 40
            - EmailMon_Content:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(255, 255, 255, 1)
                  Height: =Parent.Height - 85
                  RadiusBottomLeft: =10
                  RadiusBottomRight: =10
                  RadiusTopLeft: =10
                  RadiusTopRight: =10
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =75
                Children:
                  - EmailMon_FilterSection:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(245, 245, 245, 1)
                        Height: =140
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutGap: =10
                        PaddingBottom: =15
                        PaddingLeft: =15
                        PaddingRight: =15
                        PaddingTop: =15
                        RadiusTopLeft: =10
                        RadiusTopRight: =10
                        Width: =Parent.Width
                      Children:
                        - EmailMon_FilterRow1:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =15
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - EmailMon_DateLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: ="Date:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =60
                              - EmailMon_DatePicker:
                                  Control: DatePicker@0.0.46
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    Height: =40
                                    OnChange: =Set(_filterDate, Self.SelectedDate)
                                    SelectedDate: =_filterDate
                                    Width: =180
                              - EmailMon_StatusLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    PaddingLeft: =20
                                    Text: ="Status:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =80
                              - EmailMon_StatusDropdown:
                                  Control: ComboBox@0.0.51
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    DefaultSelectedItems: |-
                                      =If(_statusFilter = "All", ["All"],
                                         If(_statusFilter = "Success", ["Success"],
                                            If(_statusFilter = "Failed", ["Failed"],
                                               If(_statusFilter = "Pending", ["Pending"], ["All"]))))
                                    Height: =40
                                    InputTextPlaceholder: ="Select status..."
                                    Items: =["All", "Success", "Failed", "Pending"]
                                    OnChange: |-
                                      =Set(_statusFilter,
                                          If(CountRows(Self.SelectedItems) > 0,
                                             First(Self.SelectedItems).Value,
                                             "All"))
                                    Width: =180
                        - EmailMon_FilterRow2:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =15
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - EmailMon_CustomerLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: ="Customer:"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =100
                              - EmailMon_CustomerCombo:
                                  Control: ComboBox@0.0.51
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    Height: =40
                                    InputTextPlaceholder: ="Search customer..."
                                    Items: =colCustomers
                                    OnChange: |-
                                      =Set(_selectedCustomer,
                                          If(CountRows(Self.SelectedItems) > 0,
                                             First(Self.SelectedItems),
                                             Blank()))
                                    Width: =280
                                  Children:
                                    - EmailMon_CustomerName:
                                        Control: ComboBoxDataField@1.5.0
                                        Variant: textualColumn
                                        Properties:
                                          FieldDisplayName: ="Customer Name"
                                          FieldName: ="cr7bb_customername"
                                          FieldType: ="s"
                                          Order: =1
                              - EmailMon_ClearBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(128, 128, 128, 1)
                                    Height: =35
                                    Icon: ="Cancel"
                                    OnSelect: |-
                                      =Set(_filterDate, Today());
                                      Set(_statusFilter, "All");
                                      Set(_selectedCustomer, Blank());
                                      Set(_refreshTrigger, !_refreshTrigger);
                                    Text: ="Clear Filters"
                                    Width: =120
                              - EmailMon_ApplyBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    Height: =35
                                    Icon: ="Search"
                                    OnSelect: =Set(_refreshTrigger, !_refreshTrigger)
                                    Text: ="Apply Filters"
                                    Width: =120
                              - EmailMon_ResultCount:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(100, 100, 100, 1)
                                    Height: =40
                                    PaddingLeft: =15
                                    Text: |-
                                      ="Showing: " & CountRows(EmailMon_EmailGallery.AllItems) & " results"
                                    VerticalAlign: =VerticalAlign.Middle
                                    Width: =150
                  - EmailMon_EmailGallery:
                      Control: Gallery@2.15.0
                      Variant: Vertical
                      Properties:
                        Height: |-
                          =If(
                              IsBlank(_selectedEmail),
                              Parent.Height - 160,
                              Parent.Height - 460
                          )
                        Items: |-
                          =If(
                              _refreshTrigger || !_refreshTrigger,
                              SortByColumns(
                                  Filter(
                                      '[THFinanceCashCollection]Emaillogs',
                                      DateValue(cr7bb_sentdatetime) = _filterDate &&
                                      (_statusFilter = "All" ||
                                       (_statusFilter = "Success" && cr7bb_sendstatus = 'Send Status Choice'.Success) ||
                                       (_statusFilter = "Failed" && cr7bb_sendstatus = 'Send Status Choice'.Failed) ||
                                       (_statusFilter = "Pending" && cr7bb_sendstatus = 'Send Status Choice'.Pending)) &&
                                      (IsBlank(_selectedCustomer) ||
                                       Customer.'[THFinanceCashCollection]Customer' = _selectedCustomer.'[THFinanceCashCollection]Customer')
                                  ),
                                  "cr7bb_sentdatetime",
                                  SortOrder.Descending
                              )
                          )
                        OnSelect: =Set(_selectedEmail, ThisItem)
                        TemplateSize: =70
                        Width: =Parent.Width - 20
                        X: =10
                        Y: =150
                      Children:
                        - EmailMon_GalleryCard:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              Fill: |-
                                =If(
                                    !IsBlank(_selectedEmail) && ThisItem.cr7bb_thfinancecashcollectionemaillogid = _selectedEmail.cr7bb_thfinancecashcollectionemaillogid,
                                    RGBA(0, 101, 161, 0.1),
                                    RGBA(255, 255, 255, 1)
                                )
                              Height: =70
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              PaddingBottom: =10
                              PaddingLeft: =15
                              PaddingRight: =15
                              PaddingTop: =10
                              RadiusBottomLeft: =6
                              RadiusBottomRight: =6
                              RadiusTopLeft: =6
                              RadiusTopRight: =6
                              Width: =Parent.TemplateWidth - 10
                            Children:
                              - EmailMon_StatusIcon:
                                  Control: Classic/Icon@2.5.0
                                  Properties:
                                    Color: |-
                                      =If(
                                          ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Success,
                                          RGBA(16, 124, 16, 1),
                                          If(ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                             RGBA(168, 0, 0, 1),
                                             RGBA(96, 94, 92, 1))
                                      )
                                    Height: =40
                                    Icon: |-
                                      =If(
                                          ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Success,
                                          Icon.CheckBadge,
                                          If(ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                             Icon.Warning,
                                             Icon.Clock)
                                      )
                                    Width: =40
                              - EmailMon_CardInfo:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    DropShadow: =DropShadow.None
                                    LayoutDirection: =LayoutDirection.Vertical
                                    LayoutGap: =2
                                    LayoutMinHeight: =40
                                    LayoutMinWidth: =100
                                  Children:
                                    - EmailMon_CardDateTime:
                                        Control: Text@0.0.51
                                        Properties:
                                          Font: =Font.Lato
                                          FontColor: =RGBA(0, 0, 0, 1)
                                          Height: =20
                                          Text: =Text(ThisItem.cr7bb_sentdatetime, "dd/mm/yyyy hh:mm")
                                          Weight: ='TextCanvas.Weight'.Semibold
                                          Width: =Parent.Width
                                    - EmailMon_CardCustomer:
                                        Control: Text@0.0.51
                                        Properties:
                                          Font: =Font.Lato
                                          FontColor: =RGBA(100, 100, 100, 1)
                                          Height: =18
                                          Size: =12
                                          Text: |-
                                            =If(
                                                IsBlank(ThisItem.Customer),
                                                "Unknown Customer",
                                                LookUp('[THFinanceCashCollection]Customers', '[THFinanceCashCollection]Customer' = ThisItem.Customer.'[THFinanceCashCollection]Customer').cr7bb_customername
                                            )
                                          Width: =Parent.Width
                              - EmailMon_CardStatus:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    DropShadow: =DropShadow.None
                                    Fill: |-
                                      =If(
                                          ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Success,
                                          RGBA(16, 124, 16, 0.1),
                                          If(ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                             RGBA(168, 0, 0, 0.1),
                                             RGBA(96, 94, 92, 0.1))
                                      )
                                    FillPortions: =0
                                    LayoutAlignItems: =LayoutAlignItems.Center
                                    LayoutDirection: =LayoutDirection.Horizontal
                                    LayoutMinHeight: =28
                                    LayoutMinWidth: =80
                                    PaddingBottom: =5
                                    PaddingLeft: =10
                                    PaddingRight: =10
                                    PaddingTop: =5
                                  Children:
                                    - EmailMon_CardStatusText:
                                        Control: Text@0.0.51
                                        Properties:
                                          Font: =Font.Lato
                                          FontColor: |-
                                            =If(
                                                ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Success,
                                                RGBA(16, 124, 16, 1),
                                                If(ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                                   RGBA(168, 0, 0, 1),
                                                   RGBA(96, 94, 92, 1))
                                            )
                                          Height: =20
                                          Size: =12
                                          Text: |-
                                            =If(
                                                ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Success,
                                                "Success",
                                                If(ThisItem.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                                   "Failed",
                                                   "Pending")
                                            )
                                          VerticalAlign: =VerticalAlign.Middle
                                          Weight: ='TextCanvas.Weight'.Semibold
                              - EmailMon_CardAmount:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Height: =40
                                    Text: =Text(ThisItem.cr7bb_totalamount, "à¸¿#,##0.00")
                                    VerticalAlign: =VerticalAlign.Middle
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =120
                  - EmailMon_PreviewPanel:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.Regular
                        Fill: =RGBA(245, 245, 245, 1)
                        Height: =280
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutGap: =10
                        PaddingBottom: =15
                        PaddingLeft: =15
                        PaddingRight: =15
                        PaddingTop: =15
                        RadiusBottomLeft: =10
                        RadiusBottomRight: =10
                        Visible: =!IsBlank(_selectedEmail)
                        Width: =Parent.Width - 20
                        X: =10
                        Y: =Parent.Height - 290
                      Children:
                        - EmailMon_PreviewTitle:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 0, 0, 1)
                              Height: =25
                              Size: =16
                              Text: |-
                                ="Email Details: " & If(
                                    IsBlank(_selectedEmail.cr7bb_customer),
                                    "Unknown Customer",
                                    LookUp('[THFinanceCashCollection]Customers', cr7bb_customerid = _selectedEmail.cr7bb_customer).cr7bb_customername
                                )
                              Weight: ='TextCanvas.Weight'.Bold
                              Width: =Parent.Width - 30
                        - EmailMon_PreviewDivider:
                            Control: Rectangle@2.3.0
                            Properties:
                              Fill: =RGBA(200, 200, 200, 1)
                              Height: =1
                              Width: =Parent.Width - 30
                        - EmailMon_PreviewDetails:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutDirection: =LayoutDirection.Vertical
                              LayoutGap: =8
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - EmailMon_PreviewTo:
                                  Control: Text@0.0.51
                                  Properties:
                                    AutoHeight: =true
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Size: =13
                                    Text: |-
                                      ="To: " & _selectedEmail.cr7bb_recipientemails
                                    Width: =Parent.Width
                              - EmailMon_PreviewCC:
                                  Control: Text@0.0.51
                                  Properties:
                                    AutoHeight: =true
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Size: =13
                                    Text: |-
                                      ="CC: " & _selectedEmail.cr7bb_ccemails
                                    Width: =Parent.Width
                              - EmailMon_PreviewSubject:
                                  Control: Text@0.0.51
                                  Properties:
                                    AutoHeight: =true
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 0, 0, 1)
                                    Size: =13
                                    Text: |-
                                      ="Subject: " & _selectedEmail.cr7bb_emailsubject
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width
                              - EmailMon_PreviewSentInfo:
                                  Control: Text@0.0.51
                                  Properties:
                                    AutoHeight: =true
                                    Font: =Font.Lato
                                    FontColor: =RGBA(100, 100, 100, 1)
                                    Size: =12
                                    Text: |-
                                      ="Sent: " & Text(_selectedEmail.cr7bb_sentdatetime, "dd/mm/yyyy hh:mm:ss") & " | Status: " & If(
                                          _selectedEmail.cr7bb_sendstatus = 'Send Status Choice'.Success,
                                          "Success",
                                          If(_selectedEmail.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                             "Failed",
                                             "Pending")
                                      )
                                    Width: =Parent.Width
                              - EmailMon_PreviewError:
                                  Control: Text@0.0.51
                                  Properties:
                                    AutoHeight: =true
                                    Font: =Font.Lato
                                    FontColor: =RGBA(168, 0, 0, 1)
                                    Size: =13
                                    Text: |-
                                      =If(
                                          !IsBlank(_selectedEmail.cr7bb_errormessage),
                                          "Error: " & _selectedEmail.cr7bb_errormessage,
                                          ""
                                      )
                                    Visible: =!IsBlank(_selectedEmail.cr7bb_errormessage)
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width
                        - EmailMon_PreviewActions:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutMinHeight: =40
                              LayoutMinWidth: =100
                              Width: =Parent.Width - 30
                            Children:
                              - EmailMon_ResendBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    DisplayMode: |-
                                      =If(
                                          _selectedEmail.cr7bb_sendstatus = 'Send Status Choice'.Failed,
                                          DisplayMode.Edit,
                                          DisplayMode.Disabled
                                      )
                                    Height: =35
                                    Icon: ="Mail"
                                    OnSelect: |-
                                      =If(
                                          Confirm("Resend email to " & LookUp('[THFinanceCashCollection]Customers', cr7bb_customerid = _selectedEmail.cr7bb_customer).cr7bb_customername & "?"),
                                          Notify("Email resend initiated. Check status in a few minutes.", NotificationType.Information);
                                          Set(_selectedEmail, Blank());
                                          Set(_refreshTrigger, !_refreshTrigger)
                                      )
                                    Text: ="Resend Email"
                                    Width: =135
                              - EmailMon_ExportBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(100, 81, 61, 1)
                                    Height: =35
                                    Icon: ="Download"
                                    OnSelect: =Notify("Export functionality coming soon", NotificationType.Information)
                                    Text: ="Export Log"
                                    Width: =120
                              - EmailMon_DeleteBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(191, 25, 34, 1)
                                    Height: =35
                                    Icon: ="Delete"
                                    OnSelect: |-
                                      =If(
                                          Confirm("Delete this email log? This action cannot be undone."),
                                          Remove('[THFinanceCashCollection]Emaillogs', _selectedEmail);
                                          Notify("Email log deleted", NotificationType.Warning);
                                          Set(_selectedEmail, Blank());
                                          Set(_refreshTrigger, !_refreshTrigger)
                                      )
                                    Text: ="Delete"
                                    Visible: =_isAdmin
                                    Width: =90
            - EmailMon_NavigationMenu:
                Control: CanvasComponent
                ComponentName: NavigationMenu
                Properties:
                  Fill: =RGBA(255, 255, 255, 0.5)
                  Height: =Parent.Height - 70
                  Visible: =If(_showMenu, true, false)
                  Width: =260
                  Y: =70
                  navItems: =Navigation
                  navSelected: =currentScreen
