Screens:
  scnPositionCandidates:
    Properties:
      Fill: =RGBA(243, 242, 241, 1)
      LoadingSpinnerColor: =RGBA(0, 101, 161, 1)
      OnVisible: |-
        =/* Initialize screen state and load data */
        /* Set screen context */
        UpdateContext({currentScreen:"Position"});
        Set(_showMenu,false);
        Set(showAssignModal, false);

        /* Load all evaluations for this position */
        ClearCollect(
            colAllEvaluations,
            Filter(
                '[THInterviewEval]InterviewEvaluations',
                Position.'[THInterviewEval]PositionInterview' = gblSelectedPosition.'[THInterviewEval]PositionInterview'
            )
        );

        /* Load assigned candidates */
        ClearCollect(
            colAssignedCandidates,
            colAllEvaluations.Candidate
        );

        /* Reset form controls */
        Reset(PosCand_CandidateCombo);
    Children:
      - PosCand_Container:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            DropShadow: =DropShadow.None
            Height: =Parent.Height
            Width: =Parent.Width
          Children:
            - PosCand_Header:
                Control: GroupContainer@1.3.0
                Variant: AutoLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(0, 101, 161, 1)
                  Height: =55
                  LayoutAlignItems: =LayoutAlignItems.Center
                  LayoutDirection: =LayoutDirection.Horizontal
                  LayoutGap: =10
                  LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                  PaddingLeft: =15
                  PaddingRight: =15
                  RadiusBottomLeft: =8
                  RadiusBottomRight: =8
                  RadiusTopLeft: =8
                  RadiusTopRight: =8
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =10
                Children:
                  - PosCand_HeaderLeft:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        LayoutAlignItems: =LayoutAlignItems.Center
                        LayoutDirection: =LayoutDirection.Horizontal
                        LayoutGap: =10
                        LayoutMinHeight: =50
                        LayoutMinWidth: =100
                      Children:
                        - PosCand_BackBtn:
                            Control: Classic/Icon@2.5.0
                            Properties:
                              Color: =RGBA(255, 255, 255, 1)
                              Height: =50
                              Icon: =Icon.ChevronLeft
                              OnSelect: =Navigate(scnPositionLibrary)
                              PaddingBottom: =10
                              PaddingLeft: =10
                              PaddingRight: =10
                              PaddingTop: =10
                              Width: =50
                        - PosCand_HeaderTitle:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =Color.White
                              Height: =50
                              Size: =20
                              Text: ="Candidates - " & gblSelectedPosition.'Position Title'
                              VerticalAlign: =VerticalAlign.Middle
                              Weight: ='TextCanvas.Weight'.Medium
                              Width: =400
            - PosCand_Content:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  DropShadow: =DropShadow.Regular
                  Fill: =RGBA(255, 255, 255, 1)
                  Height: =Parent.Height - 85
                  RadiusBottomLeft: =10
                  RadiusBottomRight: =10
                  RadiusTopLeft: =10
                  RadiusTopRight: =10
                  Width: =Parent.Width - 20
                  X: =10
                  Y: =75
                Children:
                  - PosCand_InfoSection:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(245, 245, 245, 1)
                        Height: =70
                        LayoutDirection: =LayoutDirection.Vertical
                        LayoutGap: =5
                        PaddingBottom: =10
                        PaddingLeft: =15
                        PaddingRight: =15
                        PaddingTop: =10
                        RadiusTopLeft: =10
                        RadiusTopRight: =10
                        Width: =Parent.Width
                      Children:
                        - PosCand_PositionInfo:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(0, 101, 161, 1)
                              Height: =25
                              Size: =16
                              Text: |-
                                ="Position: " & gblSelectedPosition.'Position Title'
                              Weight: ='TextCanvas.Weight'.Semibold
                              Width: =Parent.Width - 30
                        - PosCand_InterviewerInfo:
                            Control: Text@0.0.51
                            Properties:
                              Font: =Font.Lato
                              FontColor: =RGBA(100, 100, 100, 1)
                              Height: =20
                              Size: =13
                              Text: |-
                                ="Interviewer: " & gblSelectedPosition.InterviewerEmail
                              Width: =Parent.Width - 30
                  - PosCand_CandidatesContainer:
                      Control: GroupContainer@1.3.0
                      Variant: ManualLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =Parent.Height - 90
                        Width: =Parent.Width - 20
                        X: =10
                        Y: =80
                      Children:
                        - PosCand_ActionBar:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.None
                              Fill: =RGBA(250, 250, 250, 1)
                              Height: =50
                              LayoutAlignItems: =LayoutAlignItems.Center
                              LayoutDirection: =LayoutDirection.Horizontal
                              LayoutGap: =10
                              LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                              PaddingLeft: =15
                              PaddingRight: =15
                              Width: =Parent.Width
                            Children:
                              - PosCand_AssignBtn:
                                  Control: Button@0.0.45
                                  Properties:
                                    BasePaletteColor: =RGBA(0, 101, 161, 1)
                                    Height: =35
                                    Icon: ="Add"
                                    OnSelect: =Set(showAssignModal, true)
                                    Text: ="Assign Candidate"
                                    Width: =180
                        - PosCand_CandidatesGallery:
                            Control: Gallery@2.15.0
                            Variant: BrowseLayout_Vertical_TwoTextOneImageVariant_ver5.0
                            Properties:
                              Height: =Parent.Height - PosCand_ActionBar.Height - 20
                              Items: |-
                                =Filter(
                                    '[THInterviewEval]InterviewEvaluations',
                                    Position.'[THInterviewEval]PositionInterview' = gblSelectedPosition.'[THInterviewEval]PositionInterview'
                                )
                              TemplatePadding: =5
                              TemplateSize: =200
                              Width: =Parent.Width - 20
                              X: =10
                              Y: =PosCand_ActionBar.Height + 10
                            Children:
                              - PosCand_CandidateCard:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    Fill: =RGBA(255, 255, 255, 1)
                                    LayoutAlignItems: =LayoutAlignItems.Center
                                    LayoutDirection: =LayoutDirection.Horizontal
                                    LayoutGap: =15
                                    LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                                    PaddingBottom: =10
                                    PaddingLeft: =15
                                    PaddingRight: =15
                                    PaddingTop: =10
                                    RadiusBottomLeft: =6
                                    RadiusBottomRight: =6
                                    RadiusTopLeft: =6
                                    RadiusTopRight: =6
                                    Width: =1296
                                  Children:
                                    - PosCand_InfoColumn:
                                        Control: GroupContainer@1.3.0
                                        Variant: AutoLayout
                                        Properties:
                                          DropShadow: =DropShadow.None
                                          LayoutDirection: =LayoutDirection.Vertical
                                          LayoutGap: =5
                                          LayoutMinHeight: =40
                                          LayoutMinWidth: =200
                                        Children:
                                          - PosCand_CandidateName:
                                              Control: Text@0.0.51
                                              Properties:
                                                Font: =Font.Lato
                                                FontColor: =RGBA(0, 101, 161, 1)
                                                Height: =30
                                                Size: =16
                                                Text: =ThisItem.Candidate.FirstName & " " & ThisItem.Candidate.LastName
                                                Weight: ='TextCanvas.Weight'.Semibold
                                                Width: =Parent.Width
                                          - PosCand_CandidateEmail:
                                              Control: Text@0.0.51
                                              Properties:
                                                AutoHeight: =true
                                                Font: =Font.Lato
                                                FontColor: =RGBA(100, 100, 100, 1)
                                                Size: =13
                                                Text: =ThisItem.Candidate.Email
                                                Width: =Parent.Width
                                          - PosCand_Status:
                                              Control: Text@0.0.51
                                              Properties:
                                                AutoHeight: =true
                                                Font: =Font.Lato
                                                FontColor: |-
                                                  =If(
                                                      ThisItem.'Status (cr76f_status)' = "Submitted",
                                                      RGBA(0, 128, 0, 1),
                                                      If(
                                                          ThisItem.'Status (cr76f_status)' = "Draft",
                                                          RGBA(255, 165, 0, 1),
                                                          RGBA(100, 100, 100, 1)
                                                      )
                                                  )
                                                Size: =12
                                                Text: |-
                                                  ="Evaluation Status: " & ThisItem.'Status (cr76f_status)'
                                                Weight: ='TextCanvas.Weight'.Semibold
                                                Width: =Parent.Width
                                          - PosCand_InterviewDate:
                                              Control: Text@0.0.51
                                              Properties:
                                                AutoHeight: =true
                                                Font: =Font.Lato
                                                FontColor: =RGBA(100, 100, 100, 1)
                                                Size: =12
                                                Text: |-
                                                  ="Interview Date: " & If(IsBlank(ThisItem.InterviewDate), "-", Text(ThisItem.InterviewDate, "mmm dd, yyyy"))
                                                Width: =Parent.Width
                                          - PosCand_Score:
                                              Control: Text@0.0.51
                                              Properties:
                                                AutoHeight: =true
                                                Font: =Font.Lato
                                                FontColor: =RGBA(100, 100, 100, 1)
                                                Size: =12
                                                Text: |-
                                                  =If(
                                                      ThisItem.'Status (cr76f_status)' = "Submitted",
                                                      "Score: " & Text(ThisItem.AverageScore, "0.00") & " | " & ThisItem.FinalRecommendation,
                                                      ""
                                                  )
                                                Visible: =ThisItem.'Status (cr76f_status)' = "Submitted"
                                                Width: =Parent.Width
                                          - PosCand_DeclarationStatus:
                                              Control: Text@0.0.51
                                              Properties:
                                                AutoHeight: =true
                                                Font: =Font.Lato
                                                FontColor: |-
                                                  =If(
                                                      ThisItem.nc_selfdeclarationstatus = 124850002,
                                                      RGBA(0, 128, 0, 1),
                                                      If(
                                                          ThisItem.nc_selfdeclarationstatus = 124850001,
                                                          RGBA(0, 120, 212, 1),
                                                          RGBA(255, 140, 0, 1)
                                                      )
                                                  )
                                                Size: =12
                                                Text: |-
                                                  =If(gblLanguage = "EN", "Declaration: ", "ฟอร์มรับรอง: ") &
                                                  If(
                                                      ThisItem.nc_selfdeclarationstatus = 124850002,
                                                      If(gblLanguage = "EN", "Completed", "เสร็จสิ้น"),
                                                      ThisItem.nc_selfdeclarationstatus = 124850001,
                                                      If(gblLanguage = "EN", "Sent", "ส่งแล้ว"),
                                                      If(gblLanguage = "EN", "Not Sent", "ยังไม่ส่ง")
                                                  )
                                                Weight: ='TextCanvas.Weight'.Semibold
                                                Width: =Parent.Width
                                          - PosCand_Comments:
                                              Control: Text@0.0.51
                                              Properties:
                                                AutoHeight: =true
                                                Font: =Font.Lato
                                                FontColor: =RGBA(80, 80, 80, 1)
                                                Size: =11
                                                Text: |-
                                                  =If(
                                                      !IsBlank(ThisItem.Comments),
                                                      If(gblLanguage = "EN", "Comments: ", "ความคิดเห็น: ") &
                                                      If(
                                                          Len(ThisItem.Comments) > 100,
                                                          Left(ThisItem.Comments, 100) & "...",
                                                          ThisItem.Comments
                                                      ),
                                                      ""
                                                  )
                                                Visible: =!IsBlank(ThisItem.Comments)
                                                Width: =Parent.Width
                                    - PosCand_ActionColumn:
                                        Control: GroupContainer@1.3.0
                                        Variant: AutoLayout
                                        Properties:
                                          DropShadow: =DropShadow.None
                                          FillPortions: =0
                                          LayoutAlignItems: =LayoutAlignItems.Center
                                          LayoutDirection: =LayoutDirection.Vertical
                                          LayoutGap: =8
                                          LayoutMinHeight: =40
                                          LayoutMinWidth: =150
                                          Width: =150
                                        Children:
                                          - PosCand_ViewEvalBtn:
                                              Control: Button@0.0.45
                                              Properties:
                                                BasePaletteColor: =RGBA(0, 101, 161, 1)
                                                Height: =35
                                                OnSelect: |-
                                                  =Set(gblSelectedEvaluation, ThisItem);
                                                  Navigate(scnEvaluationSummary);
                                                Text: ="View Evaluation"
                                                Width: =140
                                          - PosCand_SendDeclarationBtn:
                                              Control: Button@0.0.45
                                              Properties:
                                                BasePaletteColor: =RGBA(0, 120, 212, 1)
                                                DisplayMode: |-
                                                  =If(
                                                      ThisItem.nc_selfdeclarationstatus = 124850002,
                                                      DisplayMode.Disabled,
                                                      DisplayMode.Edit
                                                  )
                                                Height: =35
                                                OnSelect: |-
                                                  =// Send prefilled declaration form link to candidate via Power Automate
                                                  UpdateContext({_sendingDeclaration: true});

                                                  // Call Power Automate flow to send email with prefilled form
                                                  '[THInterviewEval]SendDeclarationFormLink'.Run(ThisItem.'[THInterviewEval]InterviewEvaluation');

                                                  UpdateContext({_sendingDeclaration: false});

                                                  // Refresh to show updated status
                                                  Refresh('[THInterviewEval]InterviewEvaluations');

                                                  Notify(
                                                      If(gblLanguage = "EN",
                                                         "Declaration form sent to " & ThisItem.Candidate.Email,
                                                         "ส่งแบบฟอร์มไปที่ " & ThisItem.Candidate.Email
                                                      ),
                                                      NotificationType.Success
                                                  );
                                                Text: |-
                                                  =If(
                                                      ThisItem.nc_selfdeclarationstatus = 124850002,
                                                      If(gblLanguage = "EN", "Completed ✓", "เสร็จสิ้น ✓"),
                                                      ThisItem.nc_selfdeclarationstatus = 124850001,
                                                      If(gblLanguage = "EN", "Sent ✓", "ส่งแล้ว ✓"),
                                                      If(gblLanguage = "EN", "Send Declaration", "ส่งฟอร์มรับรอง")
                                                  )
                                                Visible: =!IsBlank(ThisItem.Candidate.Email)
                                                Width: =140
                                          - PosCand_UnassignBtn:
                                              Control: Button@0.0.45
                                              Properties:
                                                BasePaletteColor: =RGBA(191, 25, 34, 1)
                                                Height: =35
                                                OnSelect: |-
                                                  =Remove('[THInterviewEval]InterviewEvaluations', ThisItem);
                                                  ClearCollect(
                                                      colAssignedCandidates,
                                                      Filter(
                                                          '[THInterviewEval]InterviewEvaluations',
                                                          Position.'[THInterviewEval]PositionInterview' = gblSelectedPosition.'[THInterviewEval]PositionInterview'
                                                      ).Candidate
                                                  );
                                                  Notify("Candidate unassigned successfully", NotificationType.Success);
                                                Text: ="Unassign"
                                                Width: =140
                  - PosCand_AssignModal:
                      Control: GroupContainer@1.3.0
                      Variant: ManualLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        Fill: =RGBA(0, 0, 0, 0.5)
                        Height: =Parent.Height
                        Visible: =showAssignModal
                        Width: =Parent.Width
                      Children:
                        - PosCand_AssignDialog:
                            Control: GroupContainer@1.3.0
                            Variant: AutoLayout
                            Properties:
                              DropShadow: =DropShadow.Bold
                              Fill: =RGBA(255, 255, 255, 1)
                              Height: =Min(550, Parent.Height - 100)
                              LayoutDirection: =LayoutDirection.Vertical
                              LayoutGap: =20
                              LayoutOverflowY: =LayoutOverflow.Scroll
                              PaddingBottom: =20
                              PaddingLeft: =30
                              PaddingRight: =30
                              PaddingTop: =20
                              RadiusBottomLeft: =8
                              RadiusBottomRight: =8
                              RadiusTopLeft: =8
                              RadiusTopRight: =8
                              X: =(Parent.Width - Self.Width) / 2
                              Y: =(Parent.Height - Self.Height) / 2
                            Children:
                              - PosCand_AssignTitle:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    FontColor: =RGBA(0, 101, 161, 1)
                                    Height: =30
                                    Size: =18
                                    Text: ="Assign Candidate"
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width - 60
                              - PosCand_CandidateLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    Height: =20
                                    Text: ="Select Candidate *"
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width - 60
                              - PosCand_CandidateCombo:
                                  Control: ComboBox@0.0.51
                                  Properties:
                                    DefaultSelectedItems: =Blank()
                                    Height: =60
                                    InputTextPlaceholder: ="Select candidate..."
                                    Items: |-
                                      =AddColumns(
                                          '[THInterviewEval]Candidates',
                                          FullName,
                                          FirstName & " " & LastName & " : " & Email
                                      )
                                    Width: =Parent.Width - 60
                                  Children:
                                    - FullName1:
                                        Control: ComboBoxDataField@1.5.0
                                        Variant: textualColumn
                                        IsLocked: true
                                        Properties:
                                          FieldDisplayName: ="FullName"
                                          FieldName: ="FullName"
                                          FieldType: ="s"
                                          Order: =2
                              - PosCand_DateLabel:
                                  Control: Text@0.0.51
                                  Properties:
                                    Font: =Font.Lato
                                    Height: =20
                                    Text: ="Interview Date (Optional)"
                                    Weight: ='TextCanvas.Weight'.Semibold
                                    Width: =Parent.Width - 60
                              - PosCand_DatePicker:
                                  Control: DatePicker@0.0.46
                                  Properties:
                                    Height: =40
                                    Width: =Parent.Width - 60
                              - PosCand_AssignButtons:
                                  Control: GroupContainer@1.3.0
                                  Variant: AutoLayout
                                  Properties:
                                    DropShadow: =DropShadow.None
                                    LayoutAlignItems: =LayoutAlignItems.Center
                                    LayoutDirection: =LayoutDirection.Horizontal
                                    LayoutGap: =10
                                    LayoutJustifyContent: =LayoutJustifyContent.End
                                    LayoutMinHeight: =40
                                    LayoutMinWidth: =100
                                    Width: =Parent.Width - 60
                                  Children:
                                    - PosCand_CancelAssignBtn:
                                        Control: Button@0.0.45
                                        Properties:
                                          BasePaletteColor: =RGBA(128, 128, 128, 1)
                                          Height: =35
                                          OnSelect: |-
                                            =Set(showAssignModal, false);
                                            Reset(PosCand_CandidateCombo);
                                            Reset(PosCand_DatePicker);
                                          Text: ="Cancel"
                                          Width: =90
                                    - PosCand_ConfirmAssignBtn:
                                        Control: Button@0.0.45
                                        Properties:
                                          BasePaletteColor: =RGBA(0, 101, 161, 1)
                                          Height: =35
                                          OnSelect: |-
                                            =If(
                                                IsBlank(PosCand_CandidateCombo.Selected),
                                                Notify("Please select a candidate", NotificationType.Warning),
                                                Patch('[THInterviewEval]InterviewEvaluations',
                                                    Defaults('[THInterviewEval]InterviewEvaluations'),
                                                    {
                                                        SubmissionID: gblSelectedPosition.'[THInterviewEval]PositionInterview'&"-"&PosCand_CandidateCombo.Selected.'[THInterviewEval]Candidate',
                                                        Candidate: PosCand_CandidateCombo.Selected,
                                                        Position: gblSelectedPosition,
                                                        InterviewerEmail: gblSelectedPosition.InterviewerEmail,
                                                        InterviewDate: If(!IsBlank(PosCand_DatePicker.SelectedDate), PosCand_DatePicker.SelectedDate, Blank()),
                                                        EvalForm: With(
                                                            {
                                                                matchedForm: First(Filter('[THInterviewEval]EvalForms', TargetPosition = gblSelectedPosition.'Position Title'))
                                                            },
                                                            If(
                                                                IsBlank(matchedForm),
                                                                First(Filter('[THInterviewEval]EvalForms', TargetPosition = "Default")),
                                                                matchedForm
                                                            )
                                                        ),
                                                        'Status (cr76f_status)': "Pending"
                                                    }
                                                );
                                                If(
                                                    IsEmpty(Errors('[THInterviewEval]InterviewEvaluations')),
                                                    Notify("Candidate assigned successfully!", NotificationType.Success);
                                                    ClearCollect(
                                                        colAllEvaluations,
                                                        Filter(
                                                            '[THInterviewEval]InterviewEvaluations',
                                                            Position.'[THInterviewEval]PositionInterview' = gblSelectedPosition.'[THInterviewEval]PositionInterview'
                                                        )
                                                    );
                                                    ClearCollect(
                                                        colAssignedCandidates,
                                                        colAllEvaluations.Candidate
                                                    );
                                                    Set(showAssignModal, false);
                                                    Reset(PosCand_CandidateCombo);
                                                    Reset(PosCand_DatePicker),
                                                    Notify("Error assigning candidate: " & First(Errors('[THInterviewEval]InterviewEvaluations')).Message, NotificationType.Error)
                                                )
                                            );
                                          Text: ="Assign"
                                          Width: =90
            - PosCand_NavigationMenu:
                Control: CanvasComponent
                ComponentName: NavigationMenu
                Properties:
                  Fill: =RGBA(255, 255, 255, 0.5)
                  Height: =Parent.Height-70
                  Visible: =If(_showMenu,true,false)
                  Width: =260
                  Y: =70
                  navItems: =Navigation
                  navSelected: =currentScreen
